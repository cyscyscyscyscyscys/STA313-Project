<!DOCTYPE html>
<meta charset="utf-8">
<title>How GDP Concentrates Within Different Levels of Maternity Cash Benefit Coverage</title>
<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #ffffff;
    color: #333333;
  }
  svg { display: block; margin: 0 auto; }
  .tooltip {
    position: absolute; pointer-events: none;
    background: rgba(0,0,0,0.85); color: #fff;
    padding: 6px 8px; border-radius: 4px;
    font-size: 12px; line-height: 1.4;
  }
  .cluster-label {
    pointer-events: none;
    text-transform: none;
    letter-spacing: 0.5px;
  }
  .subtitle {
    font-size: 13px;
  }
  .caption {
    font-size: 11px;
  }
</style>

<svg id="chart" width="960" height="640" preserveAspectRatio="xMidYMid meet"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const width = 960, height = 640;

const svg = d3.select("#chart")
  .attr("viewBox", [0,0,width,height])
  .style("background", "#ffffff");

// Title
svg.append("text")
  .attr("x", width/2).attr("y", 40)
  .attr("text-anchor", "middle")
  .attr("fill", "#222222")
  .attr("font-size", 20)
  .attr("font-weight", "600")
  .attr("letter-spacing", 1.5)
  .text("How GDP Concentrates Within Different Levels of Maternity Cash Benefit Coverage");

// Subtitle
svg.append("text")
  .attr("x", width/2).attr("y", 62)
  .attr("text-anchor", "middle")
  .attr("fill", "#555555")
  .attr("class", "subtitle")
  .text("Countries are clustered by their Cash Benefit (%) groups, with bubble size representing GDP per capita.");

// Caption
const captionY = height - 20;
svg.append("text")
  .attr("x", width/2).attr("y", captionY)
  .attr("text-anchor", "middle")
  .attr("fill", "#777777")
  .attr("class", "caption")
  .text("Bubble size = GDP per capita (US$). Colors represent cash benefit coverage groups from SOWC 2024, Table 13.");

const plotTop = 90;
const plotBottom = height - 40;
const plotHeight = plotBottom - plotTop;

const tooltip = d3.select("body").append("div")
  .attr("class","tooltip").style("opacity",0);

d3.csv("./cash_benefit_bubbles.csv", d3.autoType).then(raw => {
  const groupOrder = ["<20","20-39","40-59","60-79","80+"];

  // 只保留 group 合法且 GDP 有值的国家
  const data = raw.filter(d =>
    groupOrder.includes(d.CashBenefit_Group) &&
    d.GDP != null && !isNaN(+d.GDP)
  );

  data.forEach(d => {
    d.group = d.CashBenefit_Group;
    d.gdp = +d.GDP;
    d.cashBenefit = +d["Cash Benefit (%)"];
  });

  const groups = groupOrder.filter(g => data.some(d => d.group === g));

  const colorScale = d3.scaleOrdinal()
    .domain(groupOrder)
    .range(["#92C8D5", "#C6E5E4", "#FDEAAE", "#FCC1B4", "#F8A397"]);

  const gdpExtent = d3.extent(data, d => d.gdp);
  const radius = d3.scaleSqrt()
    .domain(gdpExtent)
    .range([6, 34]);

  data.forEach(d => { d.r = radius(d.gdp); });

  const clusterRadius = Math.min(width, plotHeight) / 3;
  const centers = {};
  groups.forEach((g,i)=>{
    const angle = (i/groups.length)*2*Math.PI - Math.PI/2;
    centers[g] = {
      x: width/2 + clusterRadius*Math.cos(angle),
      y: plotTop + plotHeight/2 + clusterRadius*Math.sin(angle)
    };
  });

  const nodes = data.map(d=>Object.assign({},d));

  const node = svg.append("g")
    .attr("stroke","#ffffff")
    .attr("stroke-width",1)
    .selectAll("circle").data(nodes).join("circle")
      .attr("r",d=>d.r)
      .attr("fill",d=>colorScale(d.group))
      .style("fill-opacity", 1)
      .on("mousemove",(event,d)=>{
        tooltip.style("opacity",1)
          .html(
            `<strong>${d.Country}</strong><br/>
             Cash Benefit: ${d.cashBenefit}%<br/>
             GDP per capita: ${d.gdp.toLocaleString()} US$<br/>
             Group: ${d.group}`
          )
          .style("left",(event.pageX+12)+"px")
          .style("top",(event.pageY+12)+"px");
      })
      .on("mouseleave",()=>tooltip.style("opacity",0));

  const simulation = d3.forceSimulation(nodes)
    .force("x", d3.forceX(d=>centers[d.group].x).strength(0.09))
    .force("y", d3.forceY(d=>centers[d.group].y).strength(0.09))
    .force("collide", d3.forceCollide(d=>d.r+1.5))
    .alpha(1)
    .alphaDecay(0.02)
    .on("tick",()=>{
      node
        .attr("cx",d=>d.x = Math.max(d.r, Math.min(width-d.r, d.x)))
        .attr("cy",d=>d.y = Math.max(plotTop+d.r, Math.min(plotBottom-d.r, d.y)));
    });

  // Cluster labels (彩色圆 + 黑字)
  const labelGroup = svg.append("g").attr("class","cluster-labels");
  const labelRadius = 22;

  const label = labelGroup.selectAll("g")
    .data(groups)
    .join("g")
      .attr("transform", g => `translate(${centers[g].x},${centers[g].y})`);

  label.append("circle")
      .attr("r", labelRadius)
      .attr("fill", g => colorScale(g))
      .attr("stroke", "#333333")
      .attr("stroke-width", 1.2)
      .attr("opacity", 0.95);

  label.append("text")
      .attr("class","cluster-label")
      .attr("text-anchor","middle")
      .attr("dominant-baseline","middle")
      .attr("fill","#000000")
      .attr("font-size", 11)
      .attr("font-weight","600")
      .text(g => g);
}).catch(err => {
  console.error("Error loading or processing CSV:", err);
});
</script>
